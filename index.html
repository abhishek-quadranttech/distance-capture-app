<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Capture - Working</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            touch-action: none;
        }
        
        /* Start screen */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 5000;
            padding: 30px;
        }
        
        #start-screen h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #start-screen p {
            font-size: 16px;
            margin-bottom: 40px;
            opacity: 0.9;
            text-align: center;
        }
        
        .start-btn {
            padding: 20px 60px;
            background: #fff;
            color: #667eea;
            border: none;
            border-radius: 50px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Container for AR/Camera view */
        #ar-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        
        #ar-container.active {
            display: block;
        }
        
        /* Status bar at top */
        #status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding: 20px;
            z-index: 1000;
        }
        
        #instruction {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 15px;
            text-align: center;
            font-weight: 600;
            border: 2px solid #00ff88;
        }
        
        /* Big distance display */
        #distance-display {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 136, 0.95);
            color: #000;
            padding: 25px 45px;
            border-radius: 20px;
            font-size: 42px;
            font-weight: 900;
            z-index: 1000;
            box-shadow: 0 5px 30px rgba(0, 255, 136, 0.5);
            border: 3px solid #fff;
            text-align: center;
            min-width: 200px;
        }
        
        #distance-display .units {
            font-size: 16px;
            font-weight: 600;
            margin-top: 5px;
            opacity: 0.8;
        }
        
        /* Crosshair */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            z-index: 900;
        }
        
        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: #00ff88;
            box-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88;
        }
        
        #crosshair::before {
            width: 80px;
            height: 4px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        #crosshair::after {
            width: 4px;
            height: 80px;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .crosshair-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 3px solid #00ff88;
            border-radius: 50%;
            box-shadow: 0 0 20px #00ff88;
        }
        
        /* Progress counter */
        #progress {
            position: fixed;
            top: 170px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            border: 2px solid #00ff88;
        }
        
        /* Captured distances list */
        #distances-panel {
            position: fixed;
            right: 15px;
            top: 220px;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-radius: 15px;
            min-width: 180px;
            max-width: 220px;
            z-index: 1000;
            border: 2px solid #00ff88;
        }
        
        #distances-panel h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #00ff88;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .distance-item {
            background: rgba(0, 255, 136, 0.2);
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
            font-size: 15px;
            font-weight: 600;
        }
        
        /* HUGE capture button */
        #capture-btn {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: 6px solid #fff;
            border-radius: 50%;
            font-size: 40px;
            z-index: 1001;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        #capture-btn:active {
            transform: translateX(-50%) scale(0.9);
        }
        
        #capture-btn::before {
            content: 'üìç';
            font-size: 45px;
        }
        
        /* Finish button */
        #finish-btn {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            padding: 18px 40px;
            background: linear-gradient(135deg, #ffd93d, #ff9800);
            color: #000;
            border: 4px solid #fff;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 5px 30px rgba(255, 217, 61, 0.6);
            display: none;
        }
        
        #finish-btn.show {
            display: block;
        }
        
        /* Results screen */
        #results-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            overflow-y: auto;
            z-index: 6000;
        }
        
        #results-screen.show {
            display: block;
        }
        
        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .results-header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 25px;
            margin: 15px 0;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .result-card h3 {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .result-card .value {
            font-size: 38px;
            font-weight: bold;
            color: #fff;
            margin: 8px 0;
        }
        
        .result-card .details {
            font-size: 15px;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #fff;
            color: #667eea;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="start-screen">
        <h1>üìè Distance Capture</h1>
        <p>Point camera at surfaces and tap the button<br>to capture 4-5 distances</p>
        <button class="start-btn" onclick="startAR()">START</button>
    </div>
    
    <!-- AR/Camera Container -->
    <div id="ar-container">
        <!-- Status bar -->
        <div id="status-bar">
            <div id="instruction">Point camera at surface</div>
        </div>
        
        <!-- Distance display -->
        <div id="distance-display">
            <div id="distance-value">-- m</div>
            <div class="units" id="distance-units">-- ft</div>
        </div>
        
        <!-- Progress -->
        <div id="progress">
            <span id="progress-text">0 / 5 distances</span>
        </div>
        
        <!-- Crosshair -->
        <div id="crosshair">
            <div class="crosshair-circle"></div>
        </div>
        
        <!-- Captured distances -->
        <div id="distances-panel">
            <h3>Captured</h3>
            <div id="distances-list"></div>
        </div>
        
        <!-- Capture button (BIG) -->
        <button id="capture-btn" onclick="captureDistance()"></button>
        
        <!-- Finish button (appears after 4) -->
        <button id="finish-btn" onclick="finishCapture()">‚úì FINISH</button>
    </div>
    
    <!-- Results Screen -->
    <div id="results-screen">
        <div class="results-header">
            <div class="success-icon">‚úì</div>
            <h1>Complete!</h1>
            <p>All distances captured successfully</p>
        </div>
        
        <div id="results-container"></div>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="downloadJSON()">
                üì• Download
            </button>
            <button class="btn btn-primary" onclick="copyToClipboard()">
                üìã Copy
            </button>
            <button class="btn btn-secondary" onclick="shareResults()">
                üîó Share
            </button>
            <button class="btn btn-secondary" onclick="restart()">
                üîÑ Restart
            </button>
        </div>
    </div>

    <script>
        console.log('App loaded');
        
        let xrSession = null;
        let xrRefSpace = null;
        let gl = null;
        let hitTestSource = null;
        let distances = [];
        let currentDistance = 0;
        const MAX_DISTANCES = 5;
        const MIN_REQUIRED = 4;
        
        async function startAR() {
            console.log('Starting AR...');
            
            try {
                // Check WebXR
                if (!navigator.xr) {
                    alert('WebXR not supported.\n\nUse Chrome browser on Android.');
                    return;
                }
                
                // Check AR support
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                console.log('AR supported:', supported);
                
                if (!supported) {
                    alert('AR not supported on this device.\n\nMake sure:\n1. You use Chrome\n2. Android 8.0+\n3. "Google Play Services for AR" is installed');
                    return;
                }
                
                // Request session
                console.log('Requesting XR session...');
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test']
                });
                
                console.log('XR session created');
                
                // Setup WebGL
                const canvas = document.createElement('canvas');
                gl = canvas.getContext('webgl', { xrCompatible: true });
                
                await xrSession.updateRenderState({
                    baseLayer: new XRWebGLLayer(xrSession, gl)
                });
                
                // Setup reference spaces
                xrRefSpace = await xrSession.requestReferenceSpace('local');
                const viewerSpace = await xrSession.requestReferenceSpace('viewer');
                hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });
                
                console.log('AR setup complete');
                
                // Show AR UI
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('ar-container').classList.add('active');
                
                // Start render loop
                xrSession.requestAnimationFrame(onXRFrame);
                
                console.log('AR started successfully!');
                
            } catch (error) {
                console.error('AR Error:', error);
                alert('Error starting AR:\n' + error.message);
            }
        }
        
        function onXRFrame(time, frame) {
            if (!xrSession) return;
            
            const session = frame.session;
            session.requestAnimationFrame(onXRFrame);
            
            const pose = frame.getViewerPose(xrRefSpace);
            
            if (pose) {
                // Clear screen
                const layer = session.renderState.baseLayer;
                gl.bindFramebuffer(gl.FRAMEBUFFER, layer.framebuffer);
                gl.clearColor(0, 0, 0, 0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                // Hit test
                if (hitTestSource && distances.length < MAX_DISTANCES) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const hitPose = hit.getPose(xrRefSpace);
                        
                        if (hitPose) {
                            const pos = hitPose.transform.position;
                            currentDistance = Math.sqrt(pos.x**2 + pos.y**2 + pos.z**2);
                            updateDistanceDisplay(currentDistance);
                        }
                    } else {
                        updateDistanceDisplay(null);
                    }
                }
            }
        }
        
        function updateDistanceDisplay(distance) {
            const valueDiv = document.getElementById('distance-value');
            const unitsDiv = document.getElementById('distance-units');
            const displayDiv = document.getElementById('distance-display');
            
            if (distance !== null && distance > 0) {
                const meters = distance.toFixed(2);
                const feet = (distance * 3.28084).toFixed(2);
                
                valueDiv.textContent = `${meters} m`;
                unitsDiv.textContent = `${feet} ft`;
                displayDiv.style.background = 'rgba(0, 255, 136, 0.95)';
            } else {
                valueDiv.textContent = 'Point at surface';
                unitsDiv.textContent = '';
                displayDiv.style.background = 'rgba(255, 68, 68, 0.95)';
            }
        }
        
        function captureDistance() {
            console.log('Capture button clicked');
            
            if (currentDistance === 0 || currentDistance === null) {
                alert('‚ö†Ô∏è Point camera at a surface first!');
                return;
            }
            
            if (distances.length >= MAX_DISTANCES) {
                alert('Already captured 5 distances!');
                return;
            }
            
            const data = {
                meters: currentDistance,
                feet: currentDistance * 3.28084,
                inches: currentDistance * 39.3701,
                cm: currentDistance * 100,
                timestamp: new Date().toISOString()
            };
            
            distances.push(data);
            console.log(`Captured distance ${distances.length}:`, data.meters.toFixed(2) + 'm');
            
            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
            
            // Update UI
            updateUI();
            
            // Auto-finish at 5
            if (distances.length === MAX_DISTANCES) {
                setTimeout(() => {
                    finishCapture();
                }, 1000);
            }
        }
        
        function updateUI() {
            // Update progress
            document.getElementById('progress-text').textContent = 
                `${distances.length} / ${MAX_DISTANCES} distances`;
            
            // Update instruction
            const instruction = document.getElementById('instruction');
            if (distances.length < MIN_REQUIRED) {
                instruction.textContent = `Capture distance ${distances.length + 1} of ${MIN_REQUIRED}`;
            } else if (distances.length === MIN_REQUIRED) {
                instruction.textContent = '‚úì 4 captured! Add 5th (optional) or finish';
            } else {
                instruction.textContent = '‚úì All 5 distances captured!';
            }
            
            // Update list
            const list = document.getElementById('distances-list');
            list.innerHTML = distances.map((d, i) => 
                `<div class="distance-item">
                    ${i + 1}. ${d.meters.toFixed(2)}m
                </div>`
            ).join('');
            
            // Show finish button after 4
            if (distances.length >= MIN_REQUIRED) {
                document.getElementById('finish-btn').classList.add('show');
            }
        }
        
        function finishCapture() {
            if (distances.length < MIN_REQUIRED) {
                if (!confirm(`Only ${distances.length} distances captured. Need at least ${MIN_REQUIRED}. Continue anyway?`)) {
                    return;
                }
            }
            
            console.log('Finishing capture...');
            
            // End XR session
            if (xrSession) {
                xrSession.end();
                xrSession = null;
            }
            
            // Show results
            showResults();
        }
        
        function showResults() {
            document.getElementById('ar-container').classList.remove('active');
            document.getElementById('results-screen').classList.add('show');
            
            const container = document.getElementById('results-container');
            container.innerHTML = distances.map((d, i) => `
                <div class="result-card">
                    <h3>Distance ${i + 1}</h3>
                    <div class="value">${d.meters.toFixed(2)} m</div>
                    <div class="details">
                        ${d.feet.toFixed(2)} ft | 
                        ${d.inches.toFixed(1)} in | 
                        ${d.cm.toFixed(1)} cm
                    </div>
                </div>
            `).join('');
            
            console.log('Results displayed');
        }
        
        function downloadJSON() {
            const data = {
                distances: distances,
                count: distances.length,
                summary: {
                    totalMeters: distances.reduce((sum, d) => sum + d.meters, 0).toFixed(2),
                    averageMeters: (distances.reduce((sum, d) => sum + d.meters, 0) / distances.length).toFixed(2)
                },
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `distances-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('Downloaded JSON');
        }
        
        function copyToClipboard() {
            const text = distances.map((d, i) => 
                `Distance ${i + 1}: ${d.meters.toFixed(2)}m (${d.feet.toFixed(2)}ft, ${d.inches.toFixed(1)}in, ${d.cm.toFixed(1)}cm)`
            ).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úì Copied to clipboard!');
            }).catch(() => {
                alert('Could not copy. Try download instead.');
            });
        }
        
        function shareResults() {
            const text = `Distance Measurements:\n` + 
                distances.map((d, i) => 
                    `${i + 1}. ${d.meters.toFixed(2)}m (${d.feet.toFixed(2)}ft)`
                ).join('\n');
            
            if (navigator.share) {
                navigator.share({
                    title: 'Distance Measurements',
                    text: text
                }).then(() => {
                    console.log('Shared successfully');
                }).catch(() => {
                    copyToClipboard();
                });
            } else {
                copyToClipboard();
            }
        }
        
        function restart() {
            distances = [];
            currentDistance = 0;
            
            document.getElementById('results-screen').classList.remove('show');
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('distances-list').innerHTML = '';
            document.getElementById('finish-btn').classList.remove('show');
            
            console.log('Restarted');
        }
    </script>
</body>
</html>
